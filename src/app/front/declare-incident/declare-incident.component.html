<div class="container">
    <div *ngIf="!selectedProject" class="project-cards-container">
      <mat-card *ngFor="let project of projects" class="project-card">
        <img mat-card-image [src]="project.image" alt="{{project.name}}" *ngIf="project.image">
        <mat-card-header>
          <mat-card-title>{{project.name}}</mat-card-title>
          <mat-card-subtitle>{{project.location}}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p>{{project.description}}</p>
        </mat-card-content>
        <mat-card-actions>
          <button mat-button color="primary" (click)="selectProject(project)">
            <mat-icon>report</mat-icon> DECLARE INCIDENT
          </button>
        </mat-card-actions>
      </mat-card>
    </div>

    <div *ngIf="selectedProject" class="incident-form-container">
      <mat-card>
        <mat-card-header>
          <div class="header-content">
            <mat-card-title>Report Incident for {{selectedProject.name}}</mat-card-title>
            <button mat-icon-button (click)="cancel()">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </mat-card-header>

        <mat-card-content>
          <form (ngSubmit)="submitIncident(incidentForm)" #incidentForm="ngForm">
            <mat-form-field appearance="outline">
              <mat-label>Your Name</mat-label>
              <input matInput [(ngModel)]="incident.reporterName" name="reporterName" required #reporterName="ngModel">
              <mat-error *ngIf="reporterName.invalid && (reporterName.dirty || reporterName.touched)">
                Please enter your name
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Severity Level</mat-label>
              <mat-select [(ngModel)]="incident.severity" name="severity" required (selectionChange)="onSeverityChange()">
                <mat-option value="LOW">
                  <div class="severity-option">
                    <span class="severity-dot low"></span>
                    Low
                    <span *ngIf="autoDetectedSeverity === 'LOW'" class="auto-detected-badge">
                      (Auto-detected)
                    </span>
                  </div>
                </mat-option>
                <mat-option value="MEDIUM">
                  <div class="severity-option">
                    <span class="severity-dot medium"></span>
                    Medium
                    <span *ngIf="autoDetectedSeverity === 'MEDIUM'" class="auto-detected-badge">
                      (Auto-detected)
                    </span>
                  </div>
                </mat-option>
                <mat-option value="HIGH">
                  <div class="severity-option">
                    <span class="severity-dot high"></span>
                    High
                    <span *ngIf="autoDetectedSeverity === 'HIGH'" class="auto-detected-badge">
                      (Auto-detected)
                    </span>
                  </div>
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="isDetectingSeverity">
                <mat-spinner diameter="16"></mat-spinner>
                Analyzing description...
              </mat-hint>
              <mat-hint *ngIf="autoDetectedSeverity && !isDetectingSeverity">
                Auto-detected severity: {{autoDetectedSeverity}}
              </mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Incident Description</mat-label>
              <textarea matInput
                       [(ngModel)]="incident.description"
                       (input)="onDescriptionChange($event)"
                       name="description"
                       required
                       rows="4"
                       #description="ngModel"></textarea>
              <mat-error *ngIf="description.invalid && (description.dirty || description.touched)">
                Please describe the incident
              </mat-error>
              <mat-hint>
                <div class="severity-indicator">
                  <span>Current severity prediction: </span>
                  <span [ngClass]="{
                    'low-severity': predictedSeverity === 'LOW',
                    'medium-severity': predictedSeverity === 'MEDIUM',
                    'high-severity': predictedSeverity === 'HIGH'
                  }">
                    {{predictedSeverity || 'Start typing...'}}
                  </span>
                  <span *ngIf="confidence" class="confidence-level">
                    ({{confidence}}% confidence)
                  </span>
                </div>
              </mat-hint>
            </mat-form-field>

            <div class="form-actions">
              <button mat-button type="button" (click)="cancel()">CANCEL</button>
              <button mat-raised-button
                      color="primary"
                      type="submit"
                      [disabled]="isSubmitting || incidentForm.invalid">
                SUBMIT INCIDENT
                <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
              </button>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
